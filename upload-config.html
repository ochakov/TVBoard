<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Configuration to Firebase</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .log-entry {
            margin-bottom: 0.25rem;
        }
        .log-success { color: #198754; }
        .log-error { color: #dc3545; }
        .log-info { color: #0d6efd; }
        .log-warning { color: #fd7e14; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">Upload Configuration to Firebase</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong>Instructions:</strong>
                            <ol class="mb-0 mt-2">
                                <li>Make sure you have configured your Firebase project in <code>firebase-config.js</code></li>
                                <li>Ensure your Firebase Realtime Database rules allow writes</li>
                                <li>Enter a configuration ID to identify this configuration</li>
                                <li>Click the "Upload Configuration" button to transfer your local config to Firebase</li>
                            </ol>
                        </div>

                        <div class="mb-3">
                            <label for="configIdInput" class="form-label">Configuration ID</label>
                            <input type="text" class="form-control" id="configIdInput" placeholder="e.g., lobby-display, office-board, main-hall" required>
                            <div class="form-text">This ID will be used to identify this configuration in Firebase. Use descriptive names like 'lobby-display' or 'office-board'.</div>
                        </div>

                        <div class="mb-3">
                            <h5>Configuration Status</h5>
                            <div id="status-container">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span>Checking Firebase connection...</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <button id="upload-btn" class="btn btn-primary" disabled>
                                <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                                Upload Configuration
                            </button>
                            <button id="verify-btn" class="btn btn-secondary ms-2" disabled>
                                Verify Upload
                            </button>
                        </div>

                        <div class="mb-3">
                            <h5>Upload Log</h5>
                            <div id="log-container" class="log-container">
                                <div class="log-entry log-info">Initializing...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- Configuration files -->
    <script src="firebase-config.js"></script>
    <script src="config.js"></script>

    <script>
        class ConfigUploader {
            constructor() {
                this.logContainer = document.getElementById('log-container');
                this.statusContainer = document.getElementById('status-container');
                this.uploadBtn = document.getElementById('upload-btn');
                this.verifyBtn = document.getElementById('verify-btn');
                
                this.init();
            }

            init() {
                this.log('Initializing configuration uploader...', 'info');
                this.checkFirebaseConnection();
                
                this.uploadBtn.addEventListener('click', () => this.uploadConfiguration());
                this.verifyBtn.addEventListener('click', () => this.verifyConfiguration());
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                this.logContainer.appendChild(logEntry);
                this.logContainer.scrollTop = this.logContainer.scrollHeight;
            }

            checkFirebaseConnection() {
                if (!window.firebaseDatabase) {
                    this.updateStatus('Firebase not connected', 'danger');
                    this.log('Firebase database not available. Check firebase-config.js', 'error');
                    return;
                }

                // Test connection
                window.firebaseDatabase.ref('.info/connected').on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        this.updateStatus('Firebase connected', 'success');
                        this.log('Firebase connection established', 'success');
                        this.uploadBtn.disabled = false;
                        this.verifyBtn.disabled = false;
                    } else {
                        this.updateStatus('Firebase disconnected', 'warning');
                        this.log('Firebase connection lost', 'warning');
                    }
                });
            }

            updateStatus(message, type) {
                const iconClass = type === 'success' ? 'check-circle' : 
                                 type === 'danger' ? 'x-circle' : 
                                 type === 'warning' ? 'exclamation-triangle' : 'info-circle';
                
                this.statusContainer.innerHTML = `
                    <div class="alert alert-${type} mb-0 py-2">
                        <i class="fas fa-${iconClass} me-2"></i>${message}
                    </div>
                `;
            }

            async uploadConfiguration() {
                this.log('Starting configuration upload...', 'info');
                this.setButtonLoading(this.uploadBtn, true);

                try {
                    // Get configuration ID
                    const configIdInput = document.getElementById('configIdInput');
                    const configId = configIdInput.value.trim();

                    if (!configId) {
                        configIdInput.classList.add('is-invalid');
                        throw new Error('Configuration ID is required');
                    }

                    configIdInput.classList.remove('is-invalid');
                    this.log(`Using configuration ID: ${configId}`, 'info');

                    // Check if local configuration is available
                    if (typeof BULLETIN_CONFIG === 'undefined' ||
                        typeof TRANSLATIONS === 'undefined' ||
                        typeof SIZE_CONFIG === 'undefined') {
                        throw new Error('Local configuration not found. Make sure config.js is loaded.');
                    }

                    const database = window.firebaseDatabase;

                    // Upload bulletin configuration
                    this.log('Uploading bulletin configuration...', 'info');
                    await database.ref(`configurations/${configId}/bulletinConfig`).set(BULLETIN_CONFIG);
                    this.log('✓ Bulletin configuration uploaded', 'success');

                    // Upload translations
                    this.log('Uploading translations...', 'info');
                    await database.ref(`configurations/${configId}/translations`).set(TRANSLATIONS);
                    this.log('✓ Translations uploaded', 'success');

                    // Upload size configuration
                    this.log('Uploading size configuration...', 'info');
                    await database.ref(`configurations/${configId}/sizeConfig`).set(SIZE_CONFIG);
                    this.log('✓ Size configuration uploaded', 'success');

                    // Store metadata
                    const metadata = {
                        uploadedAt: new Date().toISOString(),
                        version: '1.0',
                        description: `Configuration for ${configId}`
                    };
                    await database.ref(`configurations/${configId}/metadata`).set(metadata);
                    this.log('✓ Metadata uploaded', 'success');

                    this.log(`Configuration upload completed successfully for ID: ${configId}!`, 'success');
                    this.updateStatus('Upload completed', 'success');

                } catch (error) {
                    this.log(`Upload failed: ${error.message}`, 'error');
                    this.updateStatus('Upload failed', 'danger');
                } finally {
                    this.setButtonLoading(this.uploadBtn, false);
                }
            }

            async verifyConfiguration() {
                this.log('Verifying uploaded configuration...', 'info');
                this.setButtonLoading(this.verifyBtn, true);

                try {
                    // Get configuration ID
                    const configIdInput = document.getElementById('configIdInput');
                    const configId = configIdInput.value.trim();

                    if (!configId) {
                        configIdInput.classList.add('is-invalid');
                        throw new Error('Configuration ID is required for verification');
                    }

                    configIdInput.classList.remove('is-invalid');
                    this.log(`Verifying configuration ID: ${configId}`, 'info');

                    const database = window.firebaseDatabase;

                    // Verify bulletin configuration
                    const configSnapshot = await database.ref(`configurations/${configId}/bulletinConfig`).once('value');
                    const config = configSnapshot.val();
                    if (config) {
                        this.log(`✓ Bulletin config verified (${config.components?.length || 0} components)`, 'success');
                    } else {
                        this.log('✗ Bulletin config not found', 'error');
                    }

                    // Verify translations
                    const translationsSnapshot = await database.ref(`configurations/${configId}/translations`).once('value');
                    const translations = translationsSnapshot.val();
                    if (translations) {
                        const languages = Object.keys(translations);
                        this.log(`✓ Translations verified (${languages.join(', ')})`, 'success');
                    } else {
                        this.log('✗ Translations not found', 'error');
                    }

                    // Verify size configuration
                    const sizeConfigSnapshot = await database.ref(`configurations/${configId}/sizeConfig`).once('value');
                    const sizeConfig = sizeConfigSnapshot.val();
                    if (sizeConfig) {
                        const sizes = Object.keys(sizeConfig);
                        this.log(`✓ Size config verified (${sizes.join(', ')})`, 'success');
                    } else {
                        this.log('✗ Size config not found', 'error');
                    }

                    // Verify metadata
                    const metadataSnapshot = await database.ref(`configurations/${configId}/metadata`).once('value');
                    const metadata = metadataSnapshot.val();
                    if (metadata) {
                        this.log(`✓ Metadata verified (uploaded: ${metadata.uploadedAt})`, 'success');
                    } else {
                        this.log('✗ Metadata not found', 'error');
                    }

                    this.log(`Verification completed for configuration ID: ${configId}`, 'info');

                } catch (error) {
                    this.log(`Verification failed: ${error.message}`, 'error');
                } finally {
                    this.setButtonLoading(this.verifyBtn, false);
                }
            }

            setButtonLoading(button, loading) {
                const spinner = button.querySelector('.spinner-border');
                if (loading) {
                    button.disabled = true;
                    spinner.classList.remove('d-none');
                } else {
                    button.disabled = false;
                    spinner.classList.add('d-none');
                }
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new ConfigUploader();
        });
    </script>
</body>
</html>
